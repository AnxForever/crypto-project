{% extends "base.html" %}

{% block title %}IBEåº”ç”¨æ¼”ç¤º - å¯†ç å­¦å·¥å…·å¹³å°{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title"><i class="fas fa-user-shield"></i> IBEåº”ç”¨æ¼”ç¤º</h1>
    <p class="page-description">
        å±•ç¤ºåŸºäºèº«ä»½åŠ å¯†ç³»ç»Ÿçš„å®é™…åº”ç”¨åœºæ™¯ï¼Œä½“éªŒIBEæŠ€æœ¯çš„ç‹¬ç‰¹ä¼˜åŠ¿ã€‚
    </p>
</div>

<!-- ä¼ä¸šé‚®ä»¶åŠ å¯†æ¼”ç¤º -->
<div class="content-card">
    <h2 class="card-title"><i class="fas fa-building"></i> ä¼ä¸šé‚®ä»¶åŠ å¯†åœºæ™¯</h2>
    <p style="color: #666; margin-bottom: 20px;">
        æ¨¡æ‹Ÿä¼ä¸šå†…éƒ¨é‚®ä»¶åŠ å¯†åœºæ™¯ï¼Œä½¿ç”¨å‘˜å·¥é‚®ç®±åœ°å€ä½œä¸ºèº«ä»½æ ‡è¯†ç¬¦ï¼Œæ— éœ€äº‹å…ˆäº¤æ¢å…¬é’¥ã€‚
    </p>
    
    <div class="tool-grid">
        <div>
            <h4>å‘é€æ–¹ (HRéƒ¨é—¨)</h4>
            <div class="form-group">
                <label class="form-label">å‘é€äººé‚®ç®±:</label>
                <input type="email" class="form-control" id="senderEmail" value="hr@company.com" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">æ¥æ”¶äººé‚®ç®±:</label>
                <input type="email" class="form-control" id="receiverEmail" value="alice@company.com">
            </div>
            <div class="form-group">
                <label class="form-label">æœºå¯†æ¶ˆæ¯:</label>
                <textarea class="form-control" id="confidentialMessage" rows="4">å‘˜å·¥Aliceï¼šæ‚¨çš„è–ªèµ„è°ƒæ•´å·²è·æ‰¹å‡†ï¼Œæ–°è–ªèµ„ä¸º8000å…ƒ/æœˆï¼Œäºä¸‹æœˆç”Ÿæ•ˆã€‚è¯·ä¿å¯†å¤„ç†ã€‚</textarea>
            </div>
            <button class="btn btn-primary" onclick="sendEmailMessage()">
                <i class="fas fa-envelope"></i> å‘é€åŠ å¯†é‚®ä»¶
            </button>
        </div>
        
        <div>
            <h4>æ¥æ”¶æ–¹ (å‘˜å·¥Alice)</h4>
            <div class="form-group">
                <label class="form-label">æ”¶åˆ°çš„åŠ å¯†é‚®ä»¶:</label>
                <textarea class="form-control" id="encryptedEmail" rows="4" readonly placeholder="åŠ å¯†é‚®ä»¶å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Aliceçš„èº«ä»½éªŒè¯:</label>
                <input type="email" class="form-control" id="aliceIdentity" value="alice@company.com" readonly>
            </div>
            <button class="btn btn-primary" onclick="decryptEmailMessage()" id="decryptEmailBtn" disabled>
                <i class="fas fa-key"></i> ä½¿ç”¨èº«ä»½ç§é’¥è§£å¯†
            </button>
            <div class="output-area" id="decryptedEmail" style="margin-top: 15px;">è§£å¯†åçš„é‚®ä»¶å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
        </div>
    </div>
</div>

<!-- åŒ»ç–—æ•°æ®å…±äº«æ¼”ç¤º -->
<div class="content-card">
    <h2 class="card-title"><i class="fas fa-user-md"></i> åŒ»ç–—æ•°æ®å…±äº«åœºæ™¯</h2>
    <p style="color: #666; margin-bottom: 20px;">
        æ¼”ç¤ºåŒ»é™¢é—´æ‚£è€…æ•°æ®å®‰å…¨å…±äº«ï¼Œä½¿ç”¨æ‚£è€…èº«ä»½è¯å·ç ä½œä¸ºåŠ å¯†æ ‡è¯†ã€‚
    </p>
    
    <div class="tool-grid">
        <div>
            <h4>AåŒ»é™¢ (æ•°æ®æä¾›æ–¹)</h4>
            <div class="form-group">
                <label class="form-label">æ‚£è€…èº«ä»½è¯å·:</label>
                <input type="text" class="form-control" id="patientId" value="320123199001011234">
            </div>
            <div class="form-group">
                <label class="form-label">åŒ»ç–—æ•°æ®:</label>
                <textarea class="form-control" id="medicalData" rows="4">æ‚£è€…ï¼šå¼ ä¸‰ï¼Œè¡€å‹ï¼šOå‹ï¼Œè¿‡æ•å²ï¼šé’éœ‰ç´ è¿‡æ•ï¼Œè¯Šæ–­ï¼šè½»åº¦é«˜è¡€å‹ï¼Œå¤„æ–¹ï¼šé™å‹è¯ç‰©æ²»ç–—ã€‚</textarea>
            </div>
            <button class="btn btn-primary" onclick="shareMedicalData()">
                <i class="fas fa-share"></i> å®‰å…¨å…±äº«æ•°æ®
            </button>
        </div>
        
        <div>
            <h4>BåŒ»é™¢ (æ•°æ®æ¥æ”¶æ–¹)</h4>
            <div class="form-group">
                <label class="form-label">æ”¶åˆ°çš„åŠ å¯†æ•°æ®:</label>
                <textarea class="form-control" id="encryptedMedicalData" rows="4" readonly placeholder="åŠ å¯†çš„åŒ»ç–—æ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">æ‚£è€…èº«ä»½éªŒè¯:</label>
                <input type="text" class="form-control" id="patientVerification" value="320123199001011234" readonly>
            </div>
            <button class="btn btn-primary" onclick="accessMedicalData()" id="accessDataBtn" disabled>
                <i class="fas fa-stethoscope"></i> è®¿é—®æ‚£è€…æ•°æ®
            </button>
            <div class="output-area" id="decryptedMedicalData" style="margin-top: 15px;">è§£å¯†åçš„åŒ»ç–—æ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
        </div>
    </div>
</div>



<!-- ç³»ç»Ÿåˆå§‹åŒ–æŒ‰é’® -->
<div style="text-align: center; margin-top: 30px;">
    <button class="btn btn-secondary" onclick="initializeIBESystem()" id="initBtn">
        <i class="fas fa-cog"></i> åˆå§‹åŒ–IBEæ¼”ç¤ºç³»ç»Ÿ
    </button>
    <div id="systemStatus" style="margin-top: 15px; display: none;">
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> IBEæ¼”ç¤ºç³»ç»Ÿå·²å°±ç»ª
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let ibeSystemReady = false;

    // åˆå§‹åŒ–IBEç³»ç»Ÿ
    async function initializeIBESystem() {
        const btn = document.getElementById('initBtn');
        const originalText = btn.innerHTML;
        
        try {
            btn.innerHTML = '<span class="loading"></span> åˆå§‹åŒ–ä¸­...';
            btn.disabled = true;
            
            const response = await fetch('/api/ibe/setup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ scheme: 'boneh_franklin' })
            });
            
            const data = await response.json();
            if (data.status === 'success') {
                ibeSystemReady = true;
                document.getElementById('systemStatus').style.display = 'block';
                showAlert('IBEæ¼”ç¤ºç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸï¼', 'success');
            } else {
                throw new Error(data.error || 'ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥');
            }
        } catch (error) {
            showAlert('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // å‘é€åŠ å¯†é‚®ä»¶
    async function sendEmailMessage() {
        if (!ibeSystemReady) {
            showAlert('è¯·å…ˆåˆå§‹åŒ–IBEç³»ç»Ÿ', 'warning');
            return;
        }
        
        const receiverEmail = document.getElementById('receiverEmail').value.trim();
        const message = document.getElementById('confidentialMessage').value.trim();
        
        if (!receiverEmail || !message) {
            showAlert('è¯·è¾“å…¥æ¥æ”¶æ–¹é‚®ç®±å’Œæ¶ˆæ¯å†…å®¹', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/api/ibe/encrypt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    scheme: 'boneh_franklin',
                    identity: receiverEmail,
                    message: message
                })
            });
            
            const data = await response.json();
            if (data.status === 'success') {
                const ciphertext = typeof data.ciphertext === 'object' ? 
                    JSON.stringify(data.ciphertext, null, 2) : data.ciphertext;
                
                document.getElementById('encryptedEmail').value = ciphertext;
                document.getElementById('decryptEmailBtn').disabled = false;
                
                showAlert(`é‚®ä»¶å·²æˆåŠŸåŠ å¯†å¹¶å‘é€ç»™ ${receiverEmail}`, 'success');
            } else {
                throw new Error(data.error || 'é‚®ä»¶åŠ å¯†å¤±è´¥');
            }
        } catch (error) {
            showAlert('é‚®ä»¶å‘é€å¤±è´¥: ' + error.message, 'error');
        }
    }

    // è§£å¯†é‚®ä»¶æ¶ˆæ¯
    async function decryptEmailMessage() {
        const identity = document.getElementById('aliceIdentity').value.trim();
        const encryptedMessage = document.getElementById('encryptedEmail').value.trim();
        
        if (!encryptedMessage) {
            showAlert('æ²¡æœ‰æ”¶åˆ°åŠ å¯†é‚®ä»¶', 'warning');
            return;
        }
        
        try {
            // é¦–å…ˆæå–Aliceçš„ç§é’¥
            const extractResponse = await fetch('/api/ibe/extract', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    scheme: 'boneh_franklin',
                    identity: identity
                })
            });
            
            const extractData = await extractResponse.json();
            if (extractData.status !== 'success') {
                throw new Error('èº«ä»½éªŒè¯å¤±è´¥');
            }
            
            // ç„¶åè§£å¯†æ¶ˆæ¯
            let ciphertextData;
            try {
                ciphertextData = JSON.parse(encryptedMessage);
            } catch {
                ciphertextData = encryptedMessage;
            }
            
            const decryptResponse = await fetch('/api/ibe/decrypt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    scheme: 'boneh_franklin',
                    private_key: extractData.private_key,
                    ciphertext: ciphertextData
                })
            });
            
            const decryptData = await decryptResponse.json();
            if (decryptData.status === 'success') {
                document.getElementById('decryptedEmail').innerHTML = `
                    <div style="background: #f0f8f0; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <h5 style="color: #2e7d32; margin-bottom: 10px;">ğŸ“§ é‚®ä»¶è§£å¯†æˆåŠŸ</h5>
                        <p style="margin: 0;">${decryptData.plaintext}</p>
                    </div>
                `;
                showAlert('AliceæˆåŠŸè§£å¯†äº†HRçš„æœºå¯†é‚®ä»¶ï¼', 'success');
            } else {
                throw new Error(decryptData.error || 'é‚®ä»¶è§£å¯†å¤±è´¥');
            }
        } catch (error) {
            showAlert('è§£å¯†å¤±è´¥: ' + error.message, 'error');
        }
    }

    // å…±äº«åŒ»ç–—æ•°æ®
    async function shareMedicalData() {
        if (!ibeSystemReady) {
            showAlert('è¯·å…ˆåˆå§‹åŒ–IBEç³»ç»Ÿ', 'warning');
            return;
        }
        
        const patientId = document.getElementById('patientId').value.trim();
        const medicalData = document.getElementById('medicalData').value.trim();
        
        if (!patientId || !medicalData) {
            showAlert('è¯·è¾“å…¥æ‚£è€…èº«ä»½è¯å·å’ŒåŒ»ç–—æ•°æ®', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/api/ibe/encrypt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    scheme: 'boneh_franklin',
                    identity: patientId,
                    message: medicalData
                })
            });
            
            const data = await response.json();
            if (data.status === 'success') {
                const ciphertext = typeof data.ciphertext === 'object' ? 
                    JSON.stringify(data.ciphertext, null, 2) : data.ciphertext;
                
                document.getElementById('encryptedMedicalData').value = ciphertext;
                document.getElementById('accessDataBtn').disabled = false;
                
                showAlert('åŒ»ç–—æ•°æ®å·²å®‰å…¨åŠ å¯†ï¼Œå¯ä¾›BåŒ»é™¢è®¿é—®', 'success');
            } else {
                throw new Error(data.error || 'æ•°æ®åŠ å¯†å¤±è´¥');
            }
        } catch (error) {
            showAlert('æ•°æ®å…±äº«å¤±è´¥: ' + error.message, 'error');
        }
    }

    // è®¿é—®åŒ»ç–—æ•°æ®
    async function accessMedicalData() {
        const patientId = document.getElementById('patientVerification').value.trim();
        const encryptedData = document.getElementById('encryptedMedicalData').value.trim();
        
        if (!encryptedData) {
            showAlert('æ²¡æœ‰æ”¶åˆ°åŠ å¯†çš„åŒ»ç–—æ•°æ®', 'warning');
            return;
        }
        
        try {
            // é¦–å…ˆä¸ºæ‚£è€…èº«ä»½æå–ç§é’¥
            const extractResponse = await fetch('/api/ibe/extract', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    scheme: 'boneh_franklin',
                    identity: patientId
                })
            });
            
            const extractData = await extractResponse.json();
            if (extractData.status !== 'success') {
                throw new Error('æ‚£è€…èº«ä»½éªŒè¯å¤±è´¥');
            }
            
            // ç„¶åè§£å¯†åŒ»ç–—æ•°æ®
            let ciphertextData;
            try {
                ciphertextData = JSON.parse(encryptedData);
            } catch {
                ciphertextData = encryptedData;
            }
            
            const decryptResponse = await fetch('/api/ibe/decrypt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    scheme: 'boneh_franklin',
                    private_key: extractData.private_key,
                    ciphertext: ciphertextData
                })
            });
            
            const decryptData = await decryptResponse.json();
            if (decryptData.status === 'success') {
                document.getElementById('decryptedMedicalData').innerHTML = `
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <h5 style="color: #1565c0; margin-bottom: 10px;">ğŸ¥ åŒ»ç–—æ•°æ®è®¿é—®æˆåŠŸ</h5>
                        <p style="margin: 0;">${decryptData.plaintext}</p>
                    </div>
                `;
                showAlert('BåŒ»é™¢æˆåŠŸè®¿é—®äº†æ‚£è€…çš„åŒ»ç–—æ•°æ®ï¼', 'success');
            } else {
                throw new Error(decryptData.error || 'æ•°æ®è§£å¯†å¤±è´¥');
            }
        } catch (error) {
            showAlert('æ•°æ®è®¿é—®å¤±è´¥: ' + error.message, 'error');
        }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆå§‹åŒ–ç³»ç»Ÿ
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initializeIBESystem, 1000);
    });
</script>
{% endblock %} 