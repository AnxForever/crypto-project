{% extends "base.html" %}

{% block title %}æ€§èƒ½åˆ†æ - å¯†ç å­¦å·¥å…·å¹³å°{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title"><i class="fas fa-chart-bar"></i> æ€§èƒ½åˆ†æ</h1>
    <p class="page-description">
        åˆ†æPKEå’ŒIBEç®—æ³•çš„æ€§èƒ½è¡¨ç°ï¼ŒåŒ…æ‹¬åŠ å¯†é€Ÿåº¦å’Œèµ„æºæ¶ˆè€—ç­‰æŒ‡æ ‡ã€‚
    </p>
</div>

<!-- å¿«é€Ÿæ€§èƒ½æµ‹è¯• -->
<div class="content-card">
    <h2 class="card-title"><i class="fas fa-stopwatch"></i> æ€§èƒ½æµ‹è¯•</h2>
    <div class="form-group">
        <label class="form-label">æµ‹è¯•æ¶ˆæ¯:</label>
        <textarea class="form-control" id="testMessage" rows="3">è¿™æ˜¯ç”¨äºæ€§èƒ½æµ‹è¯•çš„ç¤ºä¾‹æ¶ˆæ¯ï¼Œç”¨æ¥è¯„ä¼°ä¸åŒç®—æ³•çš„åŠ å¯†è§£å¯†é€Ÿåº¦ã€‚</textarea>
    </div>
    
    <button class="btn btn-primary" onclick="runAllTests()" id="testBtn">
        <i class="fas fa-play"></i> å¼€å§‹æ€§èƒ½æµ‹è¯•
    </button>
    
    <div id="testProgress" style="display: none; margin-top: 20px;">
        <div style="background: #f8f9fa; border-radius: 10px; padding: 20px;">
            <div id="currentTest" style="color: #666; font-size: 14px;">å‡†å¤‡æµ‹è¯•...</div>
            <div style="background: #e0e0e0; border-radius: 5px; overflow: hidden; height: 8px; margin-top: 10px;">
                <div id="progressBar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
            </div>
        </div>
    </div>
</div>

<!-- æµ‹è¯•ç»“æœ -->
<div class="content-card" id="resultsSection" style="display: none;">
    <h2 class="card-title"><i class="fas fa-chart-line"></i> æµ‹è¯•ç»“æœ</h2>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-key"></i></div>
            <div class="stat-number" id="eccResult">-</div>
            <div class="stat-label">ECIES è€—æ—¶ (ms)</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-key"></i></div>
            <div class="stat-number" id="elgamalResult">-</div>
            <div class="stat-label">ElGamal è€—æ—¶ (ms)</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-key"></i></div>
            <div class="stat-number" id="sm2Result">-</div>
            <div class="stat-label">SM2 è€—æ—¶ (ms)</div>
        </div>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-user-shield"></i></div>
            <div class="stat-number" id="bfResult">-</div>
            <div class="stat-label">Boneh-Franklin è€—æ—¶ (ms)</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-user-shield"></i></div>
            <div class="stat-number" id="bbResult">-</div>
            <div class="stat-label">Boneh-Boyen è€—æ—¶ (ms)</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-user-shield"></i></div>
            <div class="stat-number" id="skResult">-</div>
            <div class="stat-label">Sakai-Kasahara è€—æ—¶ (ms)</div>
        </div>
    </div>
    
    <div id="winner" style="margin-top: 30px; text-align: center;">
        <div class="alert alert-success" id="winnerAlert" style="display: none;">
            <h4>ğŸ† æ€§èƒ½æœ€ä¼˜</h4>
            <p id="winnerText"></p>
        </div>
    </div>
</div>

<!-- ç®—æ³•ç‰¹æ€§å¯¹æ¯” -->
<div class="content-card">
    <h2 class="card-title"><i class="fas fa-balance-scale"></i> ç®—æ³•ç‰¹æ€§å¯¹æ¯”</h2>
    
    <div class="tool-grid">
        <div>
            <h4>PKEç®—æ³•ç‰¹æ€§</h4>
            <div class="feature-list">
                <div class="feature-item">
                    <strong>ECIES:</strong> æ¤­åœ†æ›²çº¿é›†æˆåŠ å¯†ï¼Œé«˜å®‰å…¨æ€§ï¼Œ256ä½å¯†é’¥
                </div>
                <div class="feature-item">
                    <strong>ElGamal:</strong> åŸºäºç¦»æ•£å¯¹æ•°ï¼Œæ¦‚ç‡æ€§åŠ å¯†ï¼Œæ”¯æŒåŒæ€
                </div>
                <div class="feature-item">
                    <strong>SM2:</strong> å›½å¯†æ ‡å‡†ï¼Œæ¤­åœ†æ›²çº¿ï¼Œå›½äº§è‡ªä¸»å¯æ§
                </div>
            </div>
        </div>
        
        <div>
            <h4>IBEç®—æ³•ç‰¹æ€§</h4>
            <div class="feature-list">
                <div class="feature-item">
                    <strong>Boneh-Franklin:</strong> é¦–ä¸ªå®ç”¨IBEæ–¹æ¡ˆï¼Œéšæœºé¢„è¨€æœºæ¨¡å‹
                </div>
                <div class="feature-item">
                    <strong>Boneh-Boyen:</strong> æ ‡å‡†æ¨¡å‹å®‰å…¨ï¼ŒåŒä¸»å¯†é’¥ç»“æ„
                </div>
                <div class="feature-item">
                    <strong>Sakai-Kasahara:</strong> é«˜æ•ˆå®ç°ï¼Œç´§å‡‘å¯†æ–‡ï¼Œæµå¯†ç 
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ä¸“é¡¹æ€§èƒ½åˆ†æå…¥å£ -->
<div class="content-card">
    <h2 class="card-title"><i class="fas fa-chart-line"></i> è¯¦ç»†æ€§èƒ½åˆ†æ</h2>
    <p style="color: #666; margin-bottom: 25px; text-align: center;">
        åŸºäºçœŸå®ç®—æ³•åº“æµ‹è¯•æ•°æ®çš„æ·±åº¦æ€§èƒ½åˆ†æå›¾è¡¨ï¼Œä¸“æ³¨ç®—æ³•å†…éƒ¨å¯¹æ¯”ã€‚
    </p>
    
    <div class="analysis-links">
        <a href="/pke-analysis" class="analysis-link-card">
            <div class="analysis-icon">
                <i class="fas fa-key"></i>
            </div>
            <div class="analysis-content">
                <h3>PKEç®—æ³•ä¸“é¡¹åˆ†æ</h3>
                <p>ECCã€ElGamalã€SM2ä¸‰ç§å…¬é’¥åŠ å¯†ç®—æ³•çš„å…¨é¢æ€§èƒ½å¯¹æ¯”</p>
                <div class="analysis-features">
                    <span class="feature-tag">æ€§èƒ½å…¨æ™¯</span>
                    <span class="feature-tag">æ•ˆç‡åˆ†æ</span>
                    <span class="feature-tag">è§„æ¨¡é€‚åº”</span>
                </div>
            </div>
            <div class="analysis-arrow">
                <i class="fas fa-arrow-right"></i>
            </div>
        </a>
        
        <a href="/ibe-analysis" class="analysis-link-card">
            <div class="analysis-icon">
                <i class="fas fa-user-shield"></i>
            </div>
            <div class="analysis-content">
                <h3>IBEç®—æ³•ä¸“é¡¹åˆ†æ</h3>
                <p>Boneh-Franklinã€Boneh-Boyenã€Sakai-Kasaharaä¸‰ç§èº«ä»½åŠ å¯†ç®—æ³•å¯¹æ¯”</p>
                <div class="analysis-features">
                    <span class="feature-tag">æ€§èƒ½å…¨æ™¯</span>
                    <span class="feature-tag">æ•ˆç‡åˆ†æ</span>
                    <span class="feature-tag">æ¶ˆæ¯é€‚åº”</span>
                </div>
            </div>
            <div class="analysis-arrow">
                <i class="fas fa-arrow-right"></i>
            </div>
        </a>
    </div>
</div>

<!-- ç®—æ³•é€‰æ‹©å»ºè®® -->
<div class="content-card">
    <h2 class="card-title"><i class="fas fa-lightbulb"></i> ç®—æ³•é€‰æ‹©å»ºè®®</h2>
    <div class="features-grid">
        <div class="feature-card">
            <div class="feature-icon">
                <i class="fas fa-rocket"></i>
            </div>
            <div class="feature-title">é«˜æ€§èƒ½åœºæ™¯</div>
            <div class="feature-description">
                æ¨èä½¿ç”¨SM2ç®—æ³•ï¼Œå¯†é’¥ç”Ÿæˆæå¿«ï¼Œæ•´ä½“æ€§èƒ½ä¼˜å¼‚ï¼Œé€‚åˆé«˜é¢‘æ¬¡æ“ä½œã€‚
            </div>
        </div>
        
        <div class="feature-card">
            <div class="feature-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="feature-title">å®‰å…¨æ€§ä¼˜å…ˆ</div>
            <div class="feature-description">
                å¯¹äºå®‰å…¨æ€§è¦æ±‚æé«˜çš„åœºæ™¯ï¼Œå»ºè®®ä½¿ç”¨ECCæˆ–SM2å›½å¯†ç®—æ³•ã€‚
            </div>
        </div>
        
        <div class="feature-card">
            <div class="feature-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="feature-title">èº«ä»½ç®¡ç†</div>
            <div class="feature-description">
                éœ€è¦ç®€åŒ–å¯†é’¥ç®¡ç†æ—¶ï¼ŒIBEç®—æ³•æä¾›åŸºäºèº«ä»½çš„åŠ å¯†æ–¹æ¡ˆã€‚Sakai-Kasaharaæ€§èƒ½æœ€ä¼˜ã€‚
            </div>
        </div>
        
        <div class="feature-card">
            <div class="feature-icon">
                <i class="fas fa-globe"></i>
            </div>
            <div class="feature-title">æ ‡å‡†å…¼å®¹</div>
            <div class="feature-description">
                è€ƒè™‘å›½é™…æ ‡å‡†å…¼å®¹æ€§å’Œå›½å†…åˆè§„è¦æ±‚ï¼Œé€‰æ‹©é€‚åˆçš„ç®—æ³•ã€‚
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // è¿è¡Œæ‰€æœ‰æµ‹è¯•
    async function runAllTests() {
        const message = document.getElementById('testMessage').value.trim();
        if (!message) {
            showAlert('è¯·è¾“å…¥æµ‹è¯•æ¶ˆæ¯', 'warning');
            return;
        }
        
        const testBtn = document.getElementById('testBtn');
        testBtn.disabled = true;
        testBtn.innerHTML = '<span class="loading"></span> æµ‹è¯•ä¸­...';
        document.getElementById('testProgress').style.display = 'block';
        
        const algorithms = [
            { name: 'ECC', type: 'pke', resultId: 'eccResult' },
            { name: 'ELGAMAL', type: 'pke', resultId: 'elgamalResult' },
            { name: 'SM2', type: 'pke', resultId: 'sm2Result' },
                            { name: 'boneh_franklin', type: 'ibe', resultId: 'bfResult' },
            { name: 'boneh_boyen', type: 'ibe', resultId: 'bbResult' },
            { name: 'sakai_kasahara', type: 'ibe', resultId: 'skResult' }
        ];
        
        const results = {};
        let bestTime = Infinity;
        let bestAlgorithm = '';
        
        for (let i = 0; i < algorithms.length; i++) {
            const algorithm = algorithms[i];
            
            // æ›´æ–°è¿›åº¦
            document.getElementById('currentTest').textContent = `æ­£åœ¨æµ‹è¯• ${algorithm.name}...`;
            document.getElementById('progressBar').style.width = `${((i + 1) / algorithms.length) * 100}%`;
            
            try {
                const duration = await testSingleAlgorithm(algorithm, message);
                results[algorithm.name] = duration;
                document.getElementById(algorithm.resultId).textContent = duration.toFixed(2);
                
                if (duration < bestTime) {
                    bestTime = duration;
                    bestAlgorithm = algorithm.name;
                }
            } catch (error) {
                console.error(`æµ‹è¯• ${algorithm.name} å¤±è´¥:`, error);
                document.getElementById(algorithm.resultId).textContent = 'é”™è¯¯';
            }
            
            // çŸ­æš‚å»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // æ˜¾ç¤ºç»“æœ
        document.getElementById('resultsSection').style.display = 'block';
        
        if (bestAlgorithm) {
            document.getElementById('winnerAlert').style.display = 'block';
            document.getElementById('winnerText').textContent = 
                `åœ¨æ­¤æ¬¡æµ‹è¯•ä¸­ï¼Œ${bestAlgorithm} ç®—æ³•è¡¨ç°æœ€ä½³ï¼Œæ€»è€—æ—¶ ${bestTime.toFixed(2)} æ¯«ç§’`;
        }
        
        testBtn.disabled = false;
        testBtn.innerHTML = '<i class="fas fa-play"></i> å¼€å§‹æ€§èƒ½æµ‹è¯•';
        document.getElementById('testProgress').style.display = 'none';
        
        showAlert('æ€§èƒ½æµ‹è¯•å®Œæˆï¼', 'success');
    }
    
    // æµ‹è¯•å•ä¸ªç®—æ³•
    async function testSingleAlgorithm(algorithm, message) {
        const startTime = performance.now();
        
        if (algorithm.type === 'pke') {
            // PKEæµ‹è¯•
            const keyResponse = await fetch('/api/pke/generate-keys', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ scheme: algorithm.name })
            });
            
            const keyData = await keyResponse.json();
            if (keyData.status !== 'success') {
                throw new Error('å¯†é’¥ç”Ÿæˆå¤±è´¥');
            }
            
            // è·å–å…¬é’¥
            let publicKey;
            if (algorithm.name === 'ELGAMAL') {
                publicKey = keyData.keys.public_key;
            } else if (algorithm.name === 'SM2') {
                publicKey = keyData.keys.public_key;
            } else {
                publicKey = keyData.keys[1];
            }
            
            // åŠ å¯†
            const encryptResponse = await fetch('/api/pke/encrypt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    scheme: algorithm.name,
                    message: message,
                    public_key: publicKey
                })
            });
            
            const encryptData = await encryptResponse.json();
            if (encryptData.status !== 'success') {
                throw new Error('åŠ å¯†å¤±è´¥');
            }
            
        } else {
            // IBEæµ‹è¯•
            const setupResponse = await fetch('/api/ibe/setup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ scheme: algorithm.name })
            });
            
            const setupData = await setupResponse.json();
            if (setupData.status !== 'success') {
                throw new Error('IBEç³»ç»Ÿè®¾ç½®å¤±è´¥');
            }
            
            // åŠ å¯†
            const encryptResponse = await fetch('/api/ibe/encrypt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    scheme: algorithm.name,
                    identity: 'test@example.com',
                    message: message
                })
            });
            
            const encryptData = await encryptResponse.json();
            if (encryptData.status !== 'success') {
                throw new Error('IBEåŠ å¯†å¤±è´¥');
            }
        }
        
        const endTime = performance.now();
        return endTime - startTime;
    }
</script>

<style>
    .feature-list {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
    }
    
    .feature-item {
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        color: #555;
        line-height: 1.6;
    }
    
    .feature-item:last-child {
        border-bottom: none;
    }
    
    .alert {
        border-radius: 15px;
        border: none;
        padding: 20px;
    }
    
    .alert-success {
        background: rgba(76, 175, 80, 0.1);
        color: #2e7d32;
        border-left: 4px solid #4caf50;
    }
    
    /* ä¸“é¡¹åˆ†æé“¾æ¥æ ·å¼ */
    .analysis-links {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 25px;
    }
    
    .analysis-link-card {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 25px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        text-decoration: none;
        color: inherit;
        transition: all 0.3s ease;
    }
    
    .analysis-link-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 40px rgba(31, 38, 135, 0.25);
        text-decoration: none;
        color: inherit;
    }
    
    .analysis-icon {
        flex-shrink: 0;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        color: white;
        font-size: 1.8rem;
    }
    
    .analysis-content {
        flex: 1;
    }
    
    .analysis-content h3 {
        color: #333;
        margin-bottom: 8px;
        font-size: 1.2rem;
        font-weight: 600;
    }
    
    .analysis-content p {
        color: #666;
        margin-bottom: 12px;
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .analysis-features {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .feature-tag {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 500;
        border: 1px solid rgba(102, 126, 234, 0.2);
    }
    
    .analysis-arrow {
        flex-shrink: 0;
        color: #667eea;
        font-size: 1.2rem;
        opacity: 0.7;
        transition: transform 0.3s ease, opacity 0.3s ease;
    }
    
    .analysis-link-card:hover .analysis-arrow {
        transform: translateX(5px);
        opacity: 1;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .analysis-links {
            grid-template-columns: 1fr;
        }
        
        .analysis-link-card {
            padding: 20px;
        }
        
        .analysis-icon {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
        }
        
        .analysis-content h3 {
            font-size: 1.1rem;
        }
    }
</style>
{% endblock %} 